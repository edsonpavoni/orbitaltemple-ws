---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Admin - Orbital Temple">
  <!-- Login Screen -->
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>Admin Login</h1>
      <p style="margin-bottom: 1.5rem; opacity: 0.8;">Enter password to access admin panel</p>
      <input
        type="password"
        id="admin-password"
        placeholder="Password"
        class="login-input"
        autocomplete="current-password"
      />
      <button id="login-button" class="login-button">Login</button>
      <div id="login-error" class="login-error" style="display: none;">Incorrect password</div>
    </div>
  </div>

  <!-- Admin Interface (hidden until authenticated) -->
  <div id="admin-interface" class="admin-container" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h1 style="margin: 0;">Name Ascension Admin</h1>
      <button id="logout-button" class="btn-logout">Logout</button>
    </div>

    <div class="stats">
      <div class="stat-card">
        <h3>Total Names</h3>
        <p class="stat-number" id="total-count">-</p>
      </div>
      <div class="stat-card">
        <h3>Pending</h3>
        <p class="stat-number" id="pending-count">-</p>
      </div>
      <div class="stat-card">
        <h3>Sent</h3>
        <p class="stat-number" id="sent-count">-</p>
      </div>
      <div class="stat-card">
        <h3>Confirmed</h3>
        <p class="stat-number" id="confirmed-count">-</p>
      </div>
    </div>

    <div class="controls">
      <input
        type="text"
        id="search"
        placeholder="Search by name or email..."
        class="search-input"
      />
      <select id="filter" class="filter-select">
        <option value="all">All Status</option>
        <option value="pending">Pending</option>
        <option value="sent">Sent</option>
        <option value="confirmed">Confirmed</option>
        <option value="deleted">Deleted</option>
      </select>
      <button id="load-all" class="btn-load-all" style="display: none;">Load All Names</button>
      <button id="refresh" class="btn-refresh">Refresh</button>
      <button id="export-csv" class="btn-export">‚Üì Export Unsent CSV</button>
      <label for="upload-csv" class="btn-upload">
        ‚Üë Upload Confirmed CSV
        <input type="file" id="upload-csv" accept=".csv" style="display: none;" />
      </label>
    </div>

    <div id="load-info" class="load-info" style="display: none;">
      Showing most recent <strong id="loaded-count">100</strong> submissions. <button id="load-all-link" class="load-all-link">Load all names</button> to see complete dataset.
    </div>

    <div id="loading" class="loading">Loading names...</div>
    <div id="error" class="error" style="display: none;"></div>

    <table id="names-table" style="display: none;">
      <thead>
        <tr>
          <th style="width: 60px; text-align: center;">Status</th>
          <th style="width: 200px;">Name</th>
          <th>Details</th>
          <th style="width: 60px; text-align: center;">Country</th>
          <th style="width: 240px; text-align: center;">Actions</th>
        </tr>
      </thead>
      <tbody id="names-tbody">
      </tbody>
    </table>

    <div id="pagination" class="pagination" style="display: none;">
      <button id="prev-page" class="btn-page">‚Üê Previous</button>
      <span id="page-info" class="page-info">Page 1 of 1</span>
      <button id="next-page" class="btn-page">Next ‚Üí</button>
    </div>
  </div><!-- End admin-interface -->
</BaseLayout>

<style>
  /* Login Screen */
  .login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .login-box {
    background: rgba(255, 255, 255, 0.05);
    padding: 3rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 400px;
    width: 100%;
    text-align: center;
  }

  .login-box h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
    color: white;
  }

  .login-input {
    width: 100%;
    padding: 1rem;
    margin-bottom: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: white;
    font-size: 1rem;
    box-sizing: border-box;
  }

  .login-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .login-input:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.4);
    background: rgba(255, 255, 255, 0.15);
  }

  .login-button {
    width: 100%;
    padding: 1rem;
    background: rgba(76, 175, 80, 0.3);
    border: 1px solid rgba(76, 175, 80, 0.5);
    border-radius: 4px;
    color: #4caf50;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .login-button:hover {
    background: rgba(76, 175, 80, 0.4);
  }

  .login-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .login-error {
    margin-top: 1rem;
    padding: 0.75rem;
    background: rgba(244, 67, 54, 0.2);
    border: 1px solid rgba(244, 67, 54, 0.4);
    border-radius: 4px;
    color: #f44336;
    font-size: 0.9rem;
  }

  .btn-logout {
    padding: 0.5rem 1rem;
    background: rgba(244, 67, 54, 0.2);
    border: 1px solid rgba(244, 67, 54, 0.4);
    border-radius: 4px;
    color: #f44336;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .btn-logout:hover {
    background: rgba(244, 67, 54, 0.3);
  }

  .admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    color: white;
  }

  h1 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2.5rem;
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.05);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
  }

  .stat-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    opacity: 0.7;
  }

  .stat-number {
    margin: 0;
    font-size: 2.5rem;
    font-weight: bold;
  }

  .controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .search-input, .filter-select {
    flex: 1;
    min-width: 200px;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: white;
    font-size: 1rem;
  }

  .search-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .btn-refresh, .btn-export, .btn-upload {
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 1rem;
    white-space: nowrap;
  }

  .btn-refresh:hover, .btn-export:hover, .btn-upload:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .btn-export {
    background: rgba(76, 175, 80, 0.2);
    border-color: rgba(76, 175, 80, 0.4);
    color: #4caf50;
  }

  .btn-export:hover {
    background: rgba(76, 175, 80, 0.3);
  }

  .btn-upload {
    background: rgba(33, 150, 243, 0.2);
    border-color: rgba(33, 150, 243, 0.4);
    color: #2196f3;
    display: inline-block;
  }

  .btn-upload:hover {
    background: rgba(33, 150, 243, 0.3);
  }

  .btn-load-all {
    background: rgba(156, 39, 176, 0.2);
    border-color: rgba(156, 39, 176, 0.4);
    color: #9c27b0;
  }

  .btn-load-all:hover {
    background: rgba(156, 39, 176, 0.3);
  }

  .load-info {
    text-align: center;
    padding: 1rem;
    margin-bottom: 1rem;
    background: rgba(156, 39, 176, 0.1);
    border: 1px solid rgba(156, 39, 176, 0.3);
    border-radius: 4px;
    color: rgba(255, 255, 255, 0.9);
  }

  .load-all-link {
    background: none;
    border: none;
    color: #9c27b0;
    text-decoration: underline;
    cursor: pointer;
    font-size: inherit;
    padding: 0;
    margin-left: 0.5rem;
  }

  .load-all-link:hover {
    color: #ba68c8;
  }

  .loading, .error {
    text-align: center;
    padding: 2rem;
    font-size: 1.2rem;
  }

  .error {
    color: #ff6b6b;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    overflow: hidden;
  }

  thead {
    background: rgba(255, 255, 255, 0.1);
  }

  th, td {
    padding: 1.2rem 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  th {
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 1rem;
    color: rgba(255, 255, 255, 0.7);
    vertical-align: middle;
  }

  td {
    font-size: 1rem;
    line-height: 1.4;
    vertical-align: middle;
  }

  tbody tr {
    transition: background 0.15s ease;
  }

  tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
  }

  /* Status column - colored circles - GLOBAL for dynamic content */
  :global(.status-circle) {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: inline-block;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2);
  }

  :global(.status-circle.pending) {
    background: rgba(255, 255, 255, 0.9);
  }

  :global(.status-circle.sent) {
    background: #ffc107;
    box-shadow: 0 0 0 1px rgba(255, 193, 7, 0.3);
  }

  :global(.status-circle.confirmed) {
    background: #4caf50;
    box-shadow: 0 0 0 1px rgba(76, 175, 80, 0.3);
  }

  :global(.status-circle.deleted) {
    background: #666666;
    box-shadow: 0 0 0 1px rgba(102, 102, 102, 0.3);
  }

  /* Name column - GLOBAL for dynamic content */
  :global(.name-cell) {
    font-size: 16px;
    font-weight: 500;
    color: white;
  }

  /* Details column - GLOBAL for dynamic content */
  :global(.details-cell) {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  :global(.detail-email) {
    font-size: 16px;
    color: rgba(255, 255, 255, 0.8);
  }

  :global(.detail-ip) {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.5);
  }

  :global(.detail-time) {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.9rem;
    border-radius: 14px;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.3px;
  }

  .status-icon {
    font-size: 1rem;
    line-height: 1;
  }

  .status-pending {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
  }

  .status-sent {
    background: rgba(33, 150, 243, 0.2);
    color: #2196f3;
  }

  .status-confirmed {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
  }

  /* Actions column - GLOBAL for dynamic content */
  :global(.actions) {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: center;
  }

  :global(.btn-action) {
    background: none;
    border: none;
    padding: 0;
    color: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 400;
    text-decoration: underline;
    transition: opacity 0.15s ease;
  }

  :global(.btn-action:hover:not(:disabled)) {
    opacity: 0.7;
  }

  :global(.btn-action:disabled) {
    opacity: 0.3;
    cursor: not-allowed;
    text-decoration: none;
  }

  :global(.btn-delete) {
    color: #ff6b6b;
  }

  :global(.btn-delete:hover:not(:disabled)) {
    color: #ff5252;
  }

  .timestamp {
    font-size: 0.85rem;
    opacity: 0.8;
  }

  /* Country flag sizing */
  td[title] {
    font-size: 1.8rem;
  }

  .ip-info {
    display: inline-block;
    cursor: help;
    margin-left: 0.5rem;
    font-size: 0.85rem;
    opacity: 0.6;
    transition: opacity 0.2s;
    position: relative;
  }

  .ip-info:hover {
    opacity: 1;
  }

  .ip-tooltip {
    visibility: hidden;
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    text-align: center;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    position: absolute;
    z-index: 1000;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    font-size: 0.85rem;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .ip-info:hover .ip-tooltip {
    visibility: visible;
    opacity: 1;
  }

  .ip-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin-top: 2rem;
    padding: 1.5rem;
  }

  .btn-page {
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .btn-page:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.2);
  }

  .btn-page:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .page-info {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
    min-width: 150px;
    text-align: center;
  }
</style>

<script>
  const FUNCTIONS_URL = 'https://us-central1-orbital-temple.cloudfunctions.net';
  const ADMIN_PASSWORD_HASH = '7fea0dc3d4f7d03ce7a99144996d445c8c52c68295f237b4a23b7633d6e0d091'; // SHA-256 hash: lnjsndvVIYKNMKUBDJW45672ghj!
  const AUTH_SESSION_KEY = 'orbital_admin_auth';

  // Authentication functions
  async function hashPassword(password: string): Promise<string> {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function isAuthenticated(): boolean {
    return sessionStorage.getItem(AUTH_SESSION_KEY) === 'true';
  }

  function setAuthenticated(value: boolean) {
    if (value) {
      sessionStorage.setItem(AUTH_SESSION_KEY, 'true');
    } else {
      sessionStorage.removeItem(AUTH_SESSION_KEY);
    }
  }

  async function handleLogin() {
    const passwordInput = document.getElementById('admin-password') as HTMLInputElement;
    const loginButton = document.getElementById('login-button') as HTMLButtonElement;
    const loginError = document.getElementById('login-error') as HTMLDivElement;

    if (!passwordInput || !loginButton || !loginError) return;

    const password = passwordInput.value;

    if (!password) {
      loginError.textContent = 'Please enter a password';
      loginError.style.display = 'block';
      return;
    }

    loginButton.disabled = true;
    loginButton.textContent = 'Verifying...';
    loginError.style.display = 'none';

    try {
      const hash = await hashPassword(password);

      if (hash === ADMIN_PASSWORD_HASH) {
        // Correct password
        setAuthenticated(true);
        showAdminInterface();
      } else {
        // Incorrect password
        loginError.textContent = 'Incorrect password';
        loginError.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      }
    } catch (error) {
      console.error('Login error:', error);
      loginError.textContent = 'An error occurred';
      loginError.style.display = 'block';
    } finally {
      loginButton.disabled = false;
      loginButton.textContent = 'Login';
    }
  }

  function handleLogout() {
    setAuthenticated(false);
    showLoginScreen();
  }

  function showLoginScreen() {
    const loginScreen = document.getElementById('login-screen');
    const adminInterface = document.getElementById('admin-interface');

    if (loginScreen) loginScreen.style.display = 'flex';
    if (adminInterface) adminInterface.style.display = 'none';
  }

  function showAdminInterface() {
    const loginScreen = document.getElementById('login-screen');
    const adminInterface = document.getElementById('admin-interface');

    if (loginScreen) loginScreen.style.display = 'none';
    if (adminInterface) adminInterface.style.display = 'block';

    // Load database stats first (shows real totals)
    loadDatabaseStats();

    // Then load recent names for display
    loadNames(INITIAL_LOAD_LIMIT);
  }

  interface NameRecord {
    id: string;
    name: string;
    email: string;
    status: 'pending' | 'sent' | 'confirmed' | 'deleted';
    createdAt: { _seconds: number };
    sentAt?: { _seconds: number };
    confirmedAt?: { _seconds: number };
    deletedAt?: { _seconds: number };
    ipAddress?: string;
    country?: string;
    countryCode?: string;
  }

  let allNames: NameRecord[] = [];
  let filteredNames: NameRecord[] = [];
  let currentPage = 1;
  const ITEMS_PER_PAGE = 50;
  const INITIAL_LOAD_LIMIT = 100;
  let allNamesLoaded = false;
  let databaseStats = { total: 0, pending: 0, sent: 0, confirmed: 0 };

  async function loadDatabaseStats() {
    try {
      const response = await fetch(`${FUNCTIONS_URL}/getNameCount`);
      if (!response.ok) {
        throw new Error('Failed to fetch stats');
      }

      const data = await response.json();

      // Set database totals (all emails are now valid)
      databaseStats.total = data.stats.total;
      databaseStats.pending = data.stats.pending;
      databaseStats.sent = data.stats.sent;
      databaseStats.confirmed = data.stats.confirmed;

      updateStats();
    } catch (error) {
      console.error('Error loading database stats:', error);
    }
  }

  async function loadNames(limit?: number) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const table = document.getElementById('names-table');

    if (loading) loading.style.display = 'block';
    if (error) error.style.display = 'none';
    if (table) table.style.display = 'none';

    try {
      // Build URL with limit parameter if provided
      const url = limit ? `${FUNCTIONS_URL}/getNames?limit=${limit}` : `${FUNCTIONS_URL}/getNames`;
      const response = await fetch(url);

      if (!response.ok) {
        throw new Error('Failed to fetch names');
      }

      const data = await response.json();
      allNames = data.names;
      allNamesLoaded = !limit; // If no limit, we loaded everything

      filteredNames = allNames;
      currentPage = 1;

      renderTable();
      updatePagination();
      updateLoadInfo();

      if (loading) loading.style.display = 'none';
      if (table) table.style.display = 'table';
    } catch (err) {
      console.error('Error loading names:', err);
      if (loading) loading.style.display = 'none';
      if (error) {
        error.textContent = 'Failed to load names. Please check console for details.';
        error.style.display = 'block';
      }
    }
  }

  function updateLoadInfo() {
    const loadInfo = document.getElementById('load-info');
    const loadedCount = document.getElementById('loaded-count');

    if (!loadInfo || !loadedCount) return;

    if (!allNamesLoaded) {
      loadInfo.style.display = 'block';
      loadedCount.textContent = allNames.length.toString();
    } else {
      loadInfo.style.display = 'none';
    }
  }

  async function loadAllNames() {
    const loadAllBtn = document.getElementById('load-all-link') as HTMLButtonElement;
    if (loadAllBtn) {
      loadAllBtn.disabled = true;
      loadAllBtn.textContent = 'Loading...';
    }

    await loadNames(); // No limit = load all

    if (loadAllBtn) {
      loadAllBtn.disabled = false;
      loadAllBtn.textContent = 'Load all names';
    }
  }

  function updateStats() {
    const totalEl = document.getElementById('total-count');
    const pendingEl = document.getElementById('pending-count');
    const sentEl = document.getElementById('sent-count');
    const confirmedEl = document.getElementById('confirmed-count');

    // Use database stats instead of loaded names
    if (totalEl) totalEl.textContent = databaseStats.total.toString();
    if (pendingEl) pendingEl.textContent = databaseStats.pending.toString();
    if (sentEl) sentEl.textContent = databaseStats.sent.toString();
    if (confirmedEl) confirmedEl.textContent = databaseStats.confirmed.toString();
  }

  function formatTimestamp(timestamp?: { _seconds: number }): string {
    if (!timestamp) return '-';
    const date = new Date(timestamp._seconds * 1000);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    // Show relative time for recent timestamps
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;

    // Show short date format for older timestamps
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function getStatusIcon(status: string): string {
    switch (status) {
      case 'pending': return '‚è≥';
      case 'sent': return 'üì°';
      case 'confirmed': return '‚úì';
      default: return '';
    }
  }

  function getCountryFlag(countryCode?: string): string {
    if (!countryCode || countryCode === 'XX') return 'üåê';

    // Convert country code to flag emoji
    // Each country code letter corresponds to a regional indicator symbol
    const codePoints = countryCode
      .toUpperCase()
      .split('')
      .map(char => 127397 + char.charCodeAt(0));

    return String.fromCodePoint(...codePoints);
  }

  function renderTable() {
    const tbody = document.getElementById('names-tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    // Calculate pagination
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    const paginatedNames = filteredNames.slice(startIndex, endIndex);

    paginatedNames.forEach(name => {
      const tr = document.createElement('tr');
      const countryFlag = getCountryFlag(name.countryCode);
      const countryName = name.country || 'Unknown';
      const ipAddress = name.ipAddress || 'N/A';

      tr.innerHTML = `
        <td style="text-align: center;">
          <span class="status-circle ${name.status}" title="${name.status}"></span>
        </td>
        <td>
          <div class="name-cell">${name.name}</div>
        </td>
        <td>
          <div class="details-cell">
            <div class="detail-email">${name.email}</div>
            <div class="detail-ip">IP: ${ipAddress}</div>
            <div class="detail-time">Submitted ${formatTimestamp(name.createdAt)}</div>
          </div>
        </td>
        <td style="text-align: center;" title="${countryName}">
          ${countryFlag}
        </td>
        <td class="actions" style="vertical-align: middle;">
          <button class="btn-action" data-id="${name.id}" data-status="sent" ${name.status !== 'pending' ? 'disabled' : ''}>
            Send
          </button>
          <button class="btn-action" data-id="${name.id}" data-status="confirmed" ${name.status !== 'sent' ? 'disabled' : ''}>
            Confirmed
          </button>
          <button class="btn-action btn-delete" data-id="${name.id}" data-status="deleted" ${name.status === 'deleted' ? 'disabled' : ''}>
            Delete
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });

    // Add event listeners to buttons
    const buttons = tbody.querySelectorAll('.btn-action');
    buttons.forEach(button => {
      button.addEventListener('click', handleStatusUpdate);
    });
  }

  async function handleStatusUpdate(event: Event) {
    const button = event.target as HTMLButtonElement;
    const nameId = button.dataset.id;
    const status = button.dataset.status;

    if (!nameId || !status) return;

    // Show confirmation dialog for delete action
    if (status === 'deleted') {
      const confirmed = confirm('Are you sure you want to delete this name? This action cannot be undone.');
      if (!confirmed) return;
    }

    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Updating...';

    try {
      const response = await fetch(`${FUNCTIONS_URL}/updateNameStatus`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ nameId, status }),
      });

      if (!response.ok) {
        throw new Error('Failed to update status');
      }

      // Reload data
      await loadNames();
    } catch (err) {
      console.error('Error updating status:', err);
      alert('Failed to update status');
      button.disabled = false;
      button.textContent = originalText || 'Update';
    }
  }

  function updatePagination() {
    const pagination = document.getElementById('pagination');
    const prevButton = document.getElementById('prev-page') as HTMLButtonElement;
    const nextButton = document.getElementById('next-page') as HTMLButtonElement;
    const pageInfo = document.getElementById('page-info');

    if (!pagination || !prevButton || !nextButton || !pageInfo) return;

    const totalPages = Math.ceil(filteredNames.length / ITEMS_PER_PAGE);

    // Show pagination only if there's more than one page
    if (totalPages > 1) {
      pagination.style.display = 'flex';
    } else {
      pagination.style.display = 'none';
    }

    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage === totalPages || totalPages === 0;

    const startItem = filteredNames.length > 0 ? (currentPage - 1) * ITEMS_PER_PAGE + 1 : 0;
    const endItem = Math.min(currentPage * ITEMS_PER_PAGE, filteredNames.length);

    pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${startItem}-${endItem} of ${filteredNames.length})`;
  }

  function goToPage(page: number) {
    const totalPages = Math.ceil(filteredNames.length / ITEMS_PER_PAGE);
    if (page < 1 || page > totalPages) return;

    currentPage = page;
    renderTable();
    updatePagination();

    // Scroll to top of table
    const table = document.getElementById('names-table');
    if (table) {
      table.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  function applyFilters() {
    const searchInput = document.getElementById('search') as HTMLInputElement;
    const filterSelect = document.getElementById('filter') as HTMLSelectElement;

    const searchTerm = searchInput?.value.toLowerCase() || '';
    const statusFilter = filterSelect?.value || 'all';

    filteredNames = allNames.filter(name => {
      const matchesSearch = name.name.toLowerCase().includes(searchTerm) ||
                           name.email.toLowerCase().includes(searchTerm);
      const matchesStatus = statusFilter === 'all' || name.status === statusFilter;

      return matchesSearch && matchesStatus;
    });

    currentPage = 1; // Reset to first page when filtering
    renderTable();
    updatePagination();
  }

  function exportUnsentCSV() {
    // Get all names that are not confirmed (pending or sent)
    const unsentNames = allNames.filter(n =>
      n.status === 'pending' || n.status === 'sent'
    );

    if (unsentNames.length === 0) {
      alert('No unsent names to export!');
      return;
    }

    // Create CSV content
    const headers = ['Name', 'Email', 'Status', 'Submitted Date'];
    const rows = unsentNames.map(name => [
      name.name,
      name.email,
      name.status,
      formatTimestamp(name.createdAt)
    ]);

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');

    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `unsent-names-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log(`Exported ${unsentNames.length} unsent names`);
  }

  async function handleCSVUpload(event: Event) {
    const input = event.target as HTMLInputElement;
    const file = input.files?.[0];

    if (!file) return;

    try {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());

      // Skip header row
      const dataLines = lines.slice(1);

      let successCount = 0;
      let errorCount = 0;

      for (const line of dataLines) {
        // Parse CSV line (basic implementation)
        const match = line.match(/"([^"]+)","([^"]+)"/);
        if (!match) continue;

        const name = match[1];
        const email = match[2];

        // Find the name in our data
        const nameRecord = allNames.find(n =>
          n.name === name && n.email === email
        );

        if (nameRecord) {
          try {
            // Update to confirmed status
            const response = await fetch(`${FUNCTIONS_URL}/updateNameStatus`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                nameId: nameRecord.id,
                status: 'confirmed'
              }),
            });

            if (response.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (err) {
            console.error(`Error updating ${name}:`, err);
            errorCount++;
          }
        }
      }

      alert(`Upload complete!\n‚úì ${successCount} names confirmed\n‚úó ${errorCount} errors`);

      // Reload data
      await loadNames();
    } catch (err) {
      console.error('Error processing CSV:', err);
      alert('Failed to process CSV file');
    }

    // Reset input
    input.value = '';
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Check authentication on page load
    if (isAuthenticated()) {
      showAdminInterface();
    } else {
      showLoginScreen();
    }

    // Login form event listeners
    const loginButton = document.getElementById('login-button');
    const passwordInput = document.getElementById('admin-password') as HTMLInputElement;
    const logoutButton = document.getElementById('logout-button');

    loginButton?.addEventListener('click', handleLogin);
    passwordInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });
    logoutButton?.addEventListener('click', handleLogout);

    // Admin interface event listeners
    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('filter');
    const refreshButton = document.getElementById('refresh');
    const exportButton = document.getElementById('export-csv');
    const uploadInput = document.getElementById('upload-csv');
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    const loadAllLink = document.getElementById('load-all-link');

    searchInput?.addEventListener('input', applyFilters);
    filterSelect?.addEventListener('change', applyFilters);
    refreshButton?.addEventListener('click', () => loadNames(INITIAL_LOAD_LIMIT));
    exportButton?.addEventListener('click', exportUnsentCSV);
    uploadInput?.addEventListener('change', handleCSVUpload);
    prevButton?.addEventListener('click', () => goToPage(currentPage - 1));
    nextButton?.addEventListener('click', () => goToPage(currentPage + 1));
    loadAllLink?.addEventListener('click', loadAllNames);
  });
</script>
